YUI.add("td-viewer-model",function(e){"use strict";var t,a,i,n="max-age",s="stale-while-revalidate",r=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/,c=/\/\/(?:[^\/\.]+\.)?([^\/\.]+)\.yahoo\.com((\/[\w\-\.]+)*(\/video\/))*(.*)$/,o=e.Af.Event,l=e.TD.Applet.ViewerVerticalVideoUtil;function d(){var t=this;t.cache=e.Af.Cache,t.cache.isNativeEnabled()||(t.cache={mem:{},set:function(e,t){this.mem[e]=t},get:function(e,t){var a=this.mem[e];return t&&t(!a,a)},remove:function(e){delete this.mem[e]}}),t.staleData={}}d.prototype={add:function(e,t,a){this.cache.set(e,t,a)},remove:function(e){this.cache.remove(e)},get:function(e){var t=this;return t.cache.get(e,function(e,a,i){return a&&i&&i.isStale&&(t.staleData[a.id]=!0),a})},getList:function(e){var t,a,i,n,s=[];for(a=0,i=e.length;a<i;a++)n=e[a],(t=this.get(n))&&s.push(t);return s.length>0?s:null},uncachedKeys:function(e,t){var a,i,n,s=[];for(i=0,n=e.length;i<n;i++)a=e[i],this.contains(a,t)||s.push(a);return s.length>0?s:null},contains:function(e,t){return this.cache.get(e,function(e,a,i){return!!a&&(!!t||(!i||!i.isStale))})},getStaleData:function(){var e,t=[],a=this.staleData;for(e in a)a.hasOwnProperty(e)&&t.push(e);return t},cleanStaleData:function(){this.staleData={}}},e.namespace("TD.Viewer").Model=e.Base.create("TDViewerModel",e.Model,[e.Af.Sync],{resource:"contentList",readonly:!0,postForRead:!0,consolidate:!1,initializer:function(e){var n=this;n.itemCache=new d,n.fullItems={},n.itemMaps={},n.categories={},n.isFetching=!1,n.isBatchingPhotos=!1,n.videoItems=[],n.tilesAdsItems={},n.fullVideoItems=[],n.prefetchTimer=null,n.cacheControl=e.cache,t=e.dataFetch.NUM_PREFETCH_ITEMS,a=e.dataFetch.NUM_RENDER_ITEMS,i=e.dataFetch.NUM_BATCH_PHOTOS,n.config=e,setInterval(function(){n.updateStaleContent()},1e3*(e.dataFetch.STALE_DATA_FETCH||1800))},addToLCPList:function(e,t){var a,i=this;e.lcp&&(a=i.getCacheControl(e.type),i.itemCache.add(e.id,e,a,function(t){i.cachedUuids[e.id]=!t}),t.push(e.id))},prefetchFromList:function(e,a,i,n){var s=this,r=[];s.config.optimisticPrefetch?(r=s.getNextUuids(e,a[0].id,t,!1),i.forEach(function(e){-1!==r.indexOf(e)&&r.splice(r.indexOf(e),1)})):a.forEach(function(e){r.push(e.id)}),n.listId=e,s.prefetchItems(r,!0,n)},initContent:function(t,a,i,n,s,r){var c,o,l,d;if(!Array.isArray(a)||!Array.isArray(i))return!1;t=t||"",r=r||{},c=this,l=[],d=e.Object.getValue(r,["ads","tilesAds","enabled"]),s&&a.forEach(function(e){o=c.getCacheControl(e.type),c.itemCache.add(e.id,e,o,function(t){c.cachedUuids[e.id]=!t})}),a.forEach(function(e){c.addToLCPList(e,l)}),c.fullItems[t]=i,c.itemMaps[t]=[],c.categories[t]=n,d||(c.removeAdsFromList(a),c.removeAdsFromList(i)),r&&r.ui&&r.ui.enableModalBackfillVideoAds&&(c.extractVideoFromList(a),c.extractVideoFromList(i)),i.forEach(function(e,a){-1===c.itemMaps[t].indexOf(e.id)&&c.itemMaps[t].push(e.id),d&&"4"===e.type&&e.tiles&&(c.tilesAdsItems[e.id]=e)}),s||c.prefetchFromList(t,a,l,r)},initContentList:function(e,t,a){if(!e)return!1;this.fullItems[e]=[],this.itemMaps[e]=[],this.categories[e]=null,this.fetchContentList(e,!1,t,a)},removeAdsFromList:function(e){var t=e.length;for(t=e.length-1;t>=0;t--)"4"===e[t].type&&e.splice(t,1)},extractVideoFromList:function(e){var t,a,i=this,n=e.length;if(e)for(n=e.length-1;n>=0;n--)"3"===e[n].type&&-1===i.videoItems.indexOf(e[n].id)&&r.test(e[n].id)&&(t=!1,e[n].link&&e[n].title&&(a=e[n].link.match(c))&&a.length>=6&&("screen"!==a[1]&&"/video/"!==a[4]||(t=!0)),t&&(i.videoItems.length>=30&&(i.videoItems.shift(),i.fullVideoItems.shift()),i.videoItems.push(e[n].id),i.fullVideoItems.push(e[n])))},updateStaleContent:function(){var e;(e=this.itemCache.getStaleData())&&e.length>0&&(this.itemCache.cleanStaleData(),this.prefetchItems(e,!0))},batchContent:function(e,t,a){var i,n,s,r,c,l,d,h,m;if(Array.isArray(t)){for(e=e||"",a=a||{},n=!0,s=[],r=(i=this).itemCache,c=[],l=a.ui&&a.ui.enableVerticalVideo,m=t.length-1;m>=0;m--)if(!r.contains(t[m].id,!0)){n=!1;break}t.forEach(function(t){var a,n=t.id;-1===i.getItemIndex(e,n)&&(-1!==(h=i.getItemIndex(e,d))?(i.fullItems[e].splice(h+1,0,t),i.itemMaps[e].splice(h+1,0,n)):(i.fullItems[e].push(t),i.itemMaps[e].push(n))),d=n,i.setItemMeta(e,n,t),i.addToLCPList(t,s),l&&(a=r.get(n))&&a.verticalVideo&&c.push({id:n,verticalVideo:a.verticalVideo})}),n?l&&c.length>0&&o.fire("vertical-video:content-fetched",{content:c}):i.prefetchFromList(e,t,s,a)}},addNewContent:function(e,t,a){if(Array.isArray(t)){e=e||"",a=a||{};var i,n,s=[];for(i=t.length-1;i>=0;i--)n=t[i].id,this.itemCache.contains(n,!0)||(s.push(n),this.fullItems[e].push(t[i]),this.itemMaps[e].push(n));s.length&&(a.listId=e,this.prefetchItems(s,!0,a))}},removeContent:function(e,t){if(Array.isArray(t)){e=e||"";var a,i=this;t.forEach(function(t){(a=i.itemMaps[e].indexOf(t))>-1&&(i.fullItems[e].splice(a,1),i.itemMaps[e].splice(a,1))})}},prefetchItems:function(e,t,a,i){var n,s,r,c,o=this;if(!e||!Array.isArray(e))return i&&i(null);n=0,s=Math.min(n+20,e.length),r=[],e.length>20?(c=function(l){l&&(r=r.concat(l)),s<e.length?(n=s,s=Math.min(n+20,e.length),o.prefetchItemsBatch(e.slice(n,s),t,a,c)):i&&i(r)},o.prefetchItemsBatch(e.slice(n,s),t,a,c)):o.prefetchItemsBatch(e,t,a,i)},prefetchItemsBatch:function(t,a,i,n){var s,r,c,o=this,l=[];if(i=i||{},!t||!Array.isArray(t))return n&&n(null);for(s=t.length-1;s>=0;s--)t[s]||t.splice(s,1);return 0===t.length?n&&n(null):a||(t=o.itemCache.uncachedKeys(t,!0))?(!a&&window._perfModalFetchStart&&window._perfModalFetchStart(),o.config&&o.config.useUuidPrefix?t.forEach(function(e){if(e){var t="";(c=o.getItemMeta(i.listId,e))&&(o.config.checkIsEligibleOnly?c.is_eligible_false&&-1===e.indexOf("SS-")&&(t="SS-"):c.eligible||-1!==e.indexOf("SS-")?c.isUpsell&&-1===e.indexOf("UC-")&&(t="UC-"):t="SS-"),l.push(t+e)}}):l=t,r={params:{uuids:l.join(),category:i.listId?o.categories[i.listId]:o.get("category")}},e.Object.getValue(o,["config","uiConfig","enableVerticalVideo"])&&(r.params.ad_meta=!0,r.params.enable_vertical_video=!0),
void o.fetchData(r,a,i,n)):n&&n(null)},fetchContentList:function(t,a,i,n){var s,r=this;if(!t)return n&&n(null);i=i||{},!a&&window._perfModalFetchStart&&window._perfModalFetchStart(),s={params:{listId:t}},e.Object.getValue(r,["config","uiConfig","enableVerticalVideo"])&&(s.params.enable_vertical_video=!0,s.params.enable_content_list_ads=!0,s.params.useTumblrTags=!0),r.fetchData(s,a,i,n)},fetchData:function(t,a,i,n){var s,r=this,c=r.config&&r.config.uiConfig,d=e.Object.getValue(i,["params","enableEntities"]),h=void 0!==d?d:r.config.enableEntities,m=e.Object.getValue(i,["params","enableRelatedContent"]),u=void 0!==m?m:c&&c.related_content_enabled,f=c&&c.enableVerticalVideo;(t=t||{}).params=t.params||{},t.params.curveball=r.get("curveball"),i.params&&i.params.curveball&&(t.params.curveball=e.merge(t.params.curveball,i.params.curveball)),i.sync&&(t.context={config:i.sync}),i.pcsExclusions&&(t.params.sponsorCheck=!0),h&&(t.params.entities_enabled=!0),c&&(e.Object.getValue(c,["comments","enabled"])&&(t.params.commentsEnabled=!0),c.offnetUrlSchemeEnabled&&(t.params.offnetUrlSchemeEnabled=!0),c.adsMeta&&(t.params.ad_meta=!0),c.useCapSummary&&(t.params.use_cap_summary=!0),c.useSsYcts&&(t.params.use_ss_ycts=!0),c.lcpBodyEnabled&&(t.params.lcp_body_enabled=!0),c.nydcContent&&(t.params.nydc_content=!0),c.nydcMags&&(t.params.use_mags_nydc=!0),c.enableReadMore&&(t.params.include_category_data=!0),c.viewerDebug&&(t.params.viewerDebug=!0),c.imageResize&&(t.params.imageResize=!0),c.resizeSlideshowEnabled&&(t.params.resizeSlideshowEnabled=!0),c.linkYlk&&(t.params.linkYlk=c.linkYlk),c.yqlResizeEnabled&&(t.params.yqlResizeEnabled=c.yqlResizeEnabled),c.lazyLoad&&(t.params.lazyLoad=c.lazyLoad),c.forceRedisRead&&(t.params.forceRedisRead=c.forceRedisRead),c.videoEnrichment&&(t.params.videoEnrichment=!0),c.useSSSummary&&(t.params.useSSSummary=!0),c.rdsig_enabled&&(t.params.rdsig_enabled=!0),c.resizeIframeUrl&&(t.params.resizeIframeUrl=c.resizeIframeUrl),c.enableIframeAutoPlayException&&(t.params.enableIframeAutoPlayException=c.enableIframeAutoPlayException),c.offnetDeeplink&&(t.params.offnetDeeplink=!0),c.revShareEnabled&&(t.params.page_type=c.revSharePageType,t.params.page_design=c.revSharePageDesign,t.params.app_name=c.revShareAppName,-1!==i.userSegment&&(t.params.user_segment=i.userSegment)),c.property_attribution_enabled&&(t.params.property_attribution_enabled=!0),c.offnetAMP&&(t.params.offnetAMP=!0,c.use_ss_lcp&&(t.params.use_ss_lcp=!0),c.yMcacheAMPEnabled&&c.yMcacheHost&&(t.params.yMcacheAMPEnabled=!0,t.params.yMcacheHost=c.yMcacheHost)),c.lead_video_enabled&&(t.params.lead_video_enabled=!0),u&&(t.params.related_content_enabled=!0)),f&&(t.params.vertical_video_ar=l.getAspectRatio()),s=i.listId,r.sync("read",t,function(e,t){if(!a&&window._perfModalFetchEnd&&window._perfModalFetchEnd(),e||!t||!t.items)return n&&n(null);var i,l,d=t.items,h=[];d.forEach(function(e){e.sponsor&&(e={id:e.id,link:e.link,sponsor:e.sponsor,type:e.type}),(l=r.getItemMeta(s,e.id)||{}).interestString&&(e.entities=l.interestString),r.config.enableCategories&&e.categories&&(e.entities&&0!==e.entities.length?0!==e.categories.length&&(e.entities=e.entities+"|"+e.categories):e.entities=e.categories),c&&c.enableReadMore&&e.categoryData&&(l.categoryData=e.categoryData,r.setItemMeta(s,e.id,l)),c&&c.comments_preview&&(e.hosted||c.comments.offnet.enabled)&&(e.showCommentsBtn=!0),(c&&c.licensedFullBody&&"true"===e.is_eligible||e.hosted)&&(e.showFullBody=!0),i=r.getCacheControl(e.type),r.itemCache.add(e.id,e,i),f&&e.verticalVideo&&h.push({id:e.id,verticalVideo:e.verticalVideo})}),f&&h.length>0&&o.fire("vertical-video:content-fetched",{content:h}),n&&n(d)})},fetchItems:function(e,i,n,s){var r,c,o,l=this,d=!i,h=[],m={listId:e,entities_enabled:!0,sync:{timeout:2e3,retry:{max_retries:0}}};if(l.isFetching)s&&s(e,null);else{if(l.tilesAdsItems&&i&&l.tilesAdsItems[i])return o=l.tilesAdsItems[i],void(s&&s(e,[o]));if(a=l.config.dataFetch.NUM_RENDER_ITEMS,n&&(a=n),e=e||"",0===(r=Array.isArray(i)?i:l.getNextUuids(e,i,a)).length)return s&&s(e,null);if(Array.isArray(i)&&(i=r[0]),!(c=l.itemCache.uncachedKeys(r,!1)))return h=l.itemCache.getList(r),l.setItems(e,h,d),void(s&&s(e,h));c=l.getNextUuids(e,i,t,!0),r.forEach(function(e){c.indexOf(e)<0&&l.itemCache.contains(e,!0)&&c.unshift(e)}),c=c.slice(0,t),l.isFetching=!0,l.prefetchItems(c,!1,m,function(t){l.isFetching=!1,t=l.createAssociativeArray(t),r.forEach(function(a){var i,n=l.itemCache.get(a)||t[a];n&&(i=l.getItemMeta(e,a),n.source=i&&i.source||null,h.push(n))}),l.setItems(e,h,d),s&&s(e,h)})}},getItemIndex:function(e,t){return e&&t?this.itemMaps[e]&&this.itemMaps[e].indexOf(t):-1},getItemMeta:function(e,t){var a=this.getItemIndex(e,t);return a>=0?this.fullItems[e][a]:null},getVideoItems:function(e){var t=this;return e&&t.videoItems&&t.videoItems.length<=0&&t.fullItems[e]&&t.extractVideoFromList(t.fullItems[e]),t.videoItems},getVideoItemIndex:function(e){return e?this.videoItems&&this.videoItems.indexOf(e):-1},getVideoItemMeta:function(e){var t=this.getVideoItemIndex(e);return t>=0?this.fullVideoItems[t]:null},setItemMeta:function(e,t,a){var i=this.getItemIndex(e,t);i>=0&&(this.fullItems[e][i]=a)},setItems:function(e,t,a){var i;t&&0!==t.length&&(i=t,a&&(i=(i=this.get("items")||[]).concat(t)),this.setAttrs({items:i}))},getNextUuids:function(e,t,a,i){var n,s,r,c,o,l=this,d=[];if(e=e||"",t?i&&l.itemCache.contains(t,!0)||(d.push(t),a--):t=(s=l.get("items")).length>0?s[s.length-1].id:"",!l.fullItems[e]||typeof l.itemMaps[e].indexOf(t)>-1)return d;for(c=0,o=l.fullItems[e].length,r=l.itemMaps[e].indexOf(t)+1;a>0&&r+c<o&&(n=l.fullItems[e][r+c]);)n.videoAdAssets||i&&l.itemCache.contains(n.id,!0)||(d.push(n.id),a--),c++;return d.length>0?d:[]},createAssociativeArray:function(e){var t={};return Array.isArray(e)&&e.forEach(function(a,i){t[a.id]=e[i]}),t},getCacheControl:function(e){var t=this.cacheControl,a=e?e.toUpperCase():"STORY";return[n,"=",t[n][a]||300,",",s,"=",t[s][a]||43200].join("")},nextBatchPhotos:function(e,t){
var a,n,s=this;if(s.isBatchingPhotos||!e.id||!e.start)return t&&t(null);a=s.itemCache.get(e.id),n={params:{type:"photos",uuid:e.id,start:e.start,count:i}},s.isBatchingPhotos=!0,s.sync("read",n,function(i,n){var r,c;if(s.isBatchingPhotos=!1,r=n&&n.items,i||!r||!r[0])return t&&t(null);c=r[0].images||[],t&&t(c),a&&(a.images=a.images.concat(c),s.itemCache.add(e.id,a,s.getCacheControl(a.type)))})}},{ATTRS:{items:{value:[]}}})},"@VERSION@",{requires:["af-cache","af-sync","base-build","model","af-beacon","af-event","td-applet-viewer-vertical-video-util"]});