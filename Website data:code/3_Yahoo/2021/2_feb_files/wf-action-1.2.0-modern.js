!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("wafer-action",[],e):"object"==typeof exports?exports["wafer-action"]=e():(t.wafer=t.wafer||{},t.wafer.wafers=t.wafer.wafers||{},t.wafer.wafers["wafer-action"]=e())}("undefined"!=typeof self?self:this,function(){return function(t){function e(r){if(o[r])return o[r].exports;var n=o[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var o={};return e.m=t,e.c=o,e.d=function(t,o,r){e.o(t,o)||Object.defineProperty(t,o,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var o=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(o,"a",o),o},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="https://s.yimg.com/aaq/wf/",e(e.s="./src/entry.js")}({"./src/entry.js":function(t,e,o){"use strict";function r(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function c(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function u(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},f=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])}return t},p=function(){function t(t,e){var o=[],r=!0,n=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(o.push(a.value),!e||o.length!==e);r=!0);}catch(t){n=!0,i=t}finally{try{!r&&s.return&&s.return()}finally{if(n)throw i}}return o}return function(e,o){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,o);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),d=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),b=[],y=window.wafer,h=y.constants,v=y.features,g=y.utils,m=y.WaferBaseClass,w=g.fetchWithCache,_=h.ATTR_PREFIX,S=["handleClick"],T="wafer-action-is-true",O={block:-1,unblock:0},j=void 0,P="publisher",A=function(t){function e(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=o.appId,a=o.actionHost,s=o.crumb,c=o.id,u=o.name,l=o.selector,d=o.shouldSaveToStorage,y=o.subType,h=o.type;n(this,e);var v=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,{selector:l},{STATE_ATTRS:b}));r=t.getAttribute(_+"app-id")||r,s=t.getAttribute(_+"crumb")||s;var g=t.getAttribute(_+"action-type")||h||"follow",m=t.getAttribute(_+"action-sub-type")||y,w=t.getAttribute(_+"action-sub-type-category")||"",O=t.getAttribute(_+"action-id")||c,j=t.getAttribute(_+"action-label"),A=t.getAttribute(_+"action-name")||u,k=j&&j.split("|")||[],E=p(k,2),I=E[0],C=E[1],L={follow:a+"api/v3/topics?appId="+r,block:a+"api/v1/content/feedback/"+(m===P?P:"entities")+"?appId="+r},x=L[g];return v._util=f({},v._util,{actionHost:a,apiPath:x,appId:r,crumb:s,elem:t,falseLabel:C,id:O,mappingId:O+g+m+w,subTypeCategroy:w,shouldSaveToStorage:void 0===d?void 0:!!d,name:A,subType:m,trueLabel:I,type:g}),S.forEach(function(t){v[t]=v[t].bind(v)}),v._state={actionStatus:!1,inProgress:!1},t.classList.add("has-click"),setTimeout(function(){v.setActionStatus(t.classList.contains(T))},0),v}return a(e,t),d(e,[{key:"statusDidUpdate",value:function(t){var e=this._util.elem;if(e){var o=this._util,r=o.falseLabel,n=o.trueLabel;this._state.actionStatus=t,t?(r&&e.setAttribute("title",r),e.classList.add(T)):(n&&e.setAttribute("title",n),e.classList.remove(T))}}},{key:"saveToStorage",value:function(){if(v.localStorage){var t=this._util,o=t.id,r=t.name,n=void 0===r?"":r,i=t.subType,a=t.type,s=Date.now()+9e5;return window.localStorage.setItem(e.LS_KEY,JSON.stringify({id:o,name:n,subType:i,ttl:s,type:a})),Promise.resolve()}}},{key:"triggerTopicAction",value:function(t){var e=this._util,o=e.apiPath,n=e.id,i=e.name,a=e.shouldSaveToStorage,s=e.subType,c=e.subTypeCategroy,u=e.type,l={follow:this._state.actionStatus?"PUT":"DELETE",block:"POST"},f=l[u],p=void 0;return"follow"===u&&(p={types:r({},s,[{id:n}])},"provider"===s&&(p.types[s][0].type=c||"PROVIDER")),"block"===u&&(p={entities:[{entity_id:n,entity_type:s,score:O[this._state.actionStatus?"block":"unblock"]}]},s===P&&(p.entities[0].entity_name=i)),a?this.saveToStorage():w(o,{cache:0,clientHeaders:{Crumb:t},credentials:"include",method:f,body:JSON.stringify(p)})}},{key:"getCrumb",value:function(){var t=this._util.shouldSaveToStorage,e=this._util.crumb||j;if(e||t)return new Promise(function(t){t(e||"")});var o=this._util,r=o.appId,n=o.actionHost;return w(n+"api/v1/auth/crumb?appId="+r,{cache:0,credentials:"include"}).then(function(t){if(!(j=t.crumb))throw new Error("crumb not found");return j})}},{key:"trigger",value:function(t){var e=this;if(t){var o=t.crumb;o&&(j=o),this._util=f({},this._util,t)}var r=this._util.name,n=this._state.actionStatus;this._state.inProgress=!0,n?this.setActionStatus(!1):this.setActionStatus(!0),this.getCrumb().then(function(t){return e._state.inProgress=!1,e.triggerTopicAction(t)}).then(function(t){var o=t||{},n=o.result,i=void 0===n?{}:n,a=i.success,s=void 0===a?{}:a,c=s.entities,u=void 0===c?[]:c,f=e._util,p=f.id,d=f.subType,b=f.type,y="follow"===b&&u.some(function(t){return t.id===p}),h=null!==t&&"object"===(void 0===t?"undefined":l(t));if(!("follow"===b?y:h))throw new Error("action failed");e.didComplete(null,{id:p,name:r,subType:d,type:b})}).catch(function(t){e._state.inProgress=!1,e._state.actionStatus=!e._state.actionStatus,e.setActionStatus(e._state.actionStatus)})}},{key:"handleClick",value:function(t){t.preventDefault(),this._state.inProgress||this.trigger()}}]),e}(m);A.events={click:[["has-click","handleClick"]]},A.LS_KEY=_+"action-storage";var k=A,E=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var o=arguments[e];for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])}return t},I=function(){function t(t,e){for(var o=0;o<e.length;o++){var r=e[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,o,r){return o&&t(e.prototype,o),r&&t(e,r),e}}(),C=window.wafer,L=C.controllers,x=C.features,H=C.utils,D=L.WaferBaseController,R=H.getConfigFromJSONScriptNode,M=function(t){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=t.root,r=void 0===o?document:o,n=t.selector;s(this,e);var i=R(document.getElementById("wafer-action-config")),a=i.actionHost,u=i.appId,l=i.crumb,f=i.shouldSaveToStorage,p=c(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,{root:r,selector:n,props:{actionHost:a,appId:u,crumb:l,shouldSaveToStorage:f,selector:n},WaferClass:k})),d=p;return p.sync(),p._state=E({},p._state,{idInstanceMapping:new Map}),k.prototype.setActionStatus=function(t){var e=this._util.mappingId,o=d._state.idInstanceMapping;o.has(e)||o.set(e,[]),o.get(e).push(this),o.get(e).forEach(function(e){e.statusDidUpdate(t)})},x.localStorage&&setTimeout(function(){p.processStoredAction(i,n)},1),p}return u(e,t),I(e,[{key:"processStoredAction",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(t.shouldProcessState){var o=t.actionHost,r=t.appId,n=t.crumb,i=window.localStorage.getItem(k.LS_KEY);if(i){var a=document.createElement("div"),s={actionHost:o,appId:r,crumb:n,selector:e};try{var c=JSON.parse(i),u=c.id,l=c.name,f=c.ttl,p=void 0===f?0:f,d=c.subType,b=c.type;p&&p>=Date.now()&&b&&d&&u&&(a.setAttribute("data-wf-on","complete:setState:wfAction.entity."+b),new k(a,Object.assign({},s,{id:u,name:l,subType:d,type:b})).trigger(E({},s,{id:u,name:l,subType:d,type:b})))}catch(t){}window.localStorage.removeItem(k.LS_KEY)}}}}]),e}(D),N=M;e.default=new N({selector:".wafer-action"})}})});