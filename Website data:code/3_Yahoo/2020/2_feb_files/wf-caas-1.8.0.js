!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("wafer-caas",[],t):"object"==typeof exports?exports["wafer-caas"]=t():(e.wafer=e.wafer||{},e.wafer.wafers=e.wafer.wafers||{},e.wafer.wafers["wafer-caas"]=t())}("undefined"!=typeof self?self:this,function(){return function(e){function t(r){if(a[r])return a[r].exports;var n=a[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var a={};return t.m=e,t.c=a,t.d=function(e,a,r){t.o(e,a)||Object.defineProperty(e,a,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var a=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(a,"a",a),a},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="https://s.yimg.com/aaq/wf/",t(t.s="./src/entry.js")}({"./src/base.js":function(e,t,a){"use strict";function r(){return o=a("./src/utils.js")}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o,c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},u=function(){function e(e,t){var a=[],r=!0,n=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);r=!0);}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),l=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),f=window.wafer,d=f.base,v=f.constants,h=f.utils,m=f.WaferBaseClass,w=v.ATTR_PREFIX,p=h.convertNodeListToArray,y=h.fetchWithCache,g=h.loadCSSSync,_=h.loadScriptAsync,b=["caas-category-label","caas-collapsed","caas-url","caas-uuid"],C=/^https:\/\/s.yimg.com\/(os|aaq)\/c/,k=function(e){function t(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=a.caasConfig,s=a.errorClass,o=a.selector,l=a.successClass;n(this,t);var f=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,{errorClass:s,selector:o,successClass:l},{STATE_ATTRS:b})),d=e.getAttribute(w+"caas-cache"),v=e.getAttribute(w+"caas-collapsed"),h=e.getAttribute(w+"caas-url"),m=e.getAttribute(w+"caas-uuid"),p=e.getAttribute(w+"caas-cache-strategy")||"cacheFirst",y=e.getAttribute(w+"caas-cache-ttl"),g=e.getAttribute(w+"caas-category-label"),_=e.getAttribute("href"),C=e.getAttribute(w+"caas-prefetch"),k=e.getAttribute(w+"caas-load-assets"),E=e.getAttribute(w+"caas-timeout"),A=e.getAttribute(w+"caas-type")||"default",P=e.getAttribute(w+"caas-wrapper"),j=e.getAttribute(w+"caas-dependency"),O=j&&document.querySelector(j),S=(e.getAttribute(w+"caas-trigger-offset")||"").split(" "),T=u(S,2),I=T[0],L=T[1],M=e.getAttribute(w+"caas-trigger")||"viewport";if(f._util=c({},f._util,{"caas-collapsed":null===v||void 0===v?0:Number(v),"caas-url":h,"caas-uuid":m,cache:null===d||void 0===d?1:Number(d),caasConfig:r,cacheStrategy:p,cacheTtl:null===y||void 0===y?300:Number(y),categoryLabel:g,dependencyElem:O,isPrefetch:null===C||void 0===C?0:Number(C),timeout:null===E||void 0===E?6e3:Number(E),elem:e,errorClass:s,href:_,type:A,loadAssets:null===k||void 0===k?0:Number(k),offsetX:Number(L)||0,offsetY:Number(I)||0,selector:o,successClass:l,trigger:M,wrapper:P}),m&&f._util.isPrefetch&&window.__waferCaasCollection.addAndBeaconDuplicateId(m),"sidekick"===A){var x=e.getAttribute(w+"caas-second-node"),N=x&&document.getElementById(x);N&&(f._util.secondNode=N)}return f._state={status:status},f}return s(t,e),l(t,[{key:"loadCaasAssets",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return new Promise(function(r){var n=e._util.type,i="sidekick"===n?"CAAS_SIDEKICK":"CAAS",s=void 0,o=!0,c=!0;window.__caasModules=window.__caasModules||{},t.forEach(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.type,a=e.asset;"js"===t&&a.value&&(o=!1),"css"===t&&(c=!1)}),t.forEach(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.type,n=e.asset;s=(void 0===n?{}:n).value,C.test(s)&&("js"===t?_({src:s},function(){o=!0,c&&r()},i):"css"===t&&(window.__caasModules[i]?(c=!0,o&&r()):(window.__caasModules[i]=!0,g({src:s,text:a},function(){c=!0,o&&r()}))))})})}},{key:"updateCategoryLabel",value:function(){var e=this._util,t=e["caas-category-label"],a=e.elem;if(a&&t){var r=p(a.getElementsByClassName("caas-category-label"))[0];r&&(r.innerHTML=t)}}},{key:"fetch",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=(t.disable,this._util["caas-url"]),r=this._util["caas-uuid"];if(!a&&!r)return Promise.reject(new Error("uuid and url is missing"));var n=this._util,i=n.dependencyElem,s=n.successClass;if(i&&!i.classList.contains(s))return Promise.reject(new Error("dependency not yet complete"));var o=this._util,c=o.caasConfig,u=void 0===c?{}:c,l=o.cache,f=o.cacheStrategy,v=o.cacheTtl,h=o.elem,m=o.errorClass,w=o.secondNode,g=o.timeout,_=o.type,b=r+":"+u.contextParams;if(h.classList.contains(s))return Promise.resolve(!0);if(0!==this._state.status){var C=!1;if(a){var k=-1===a.indexOf("?")?"?":"&";a=a+k+u.contextParams}else a=(u.caasUrl||"https://www.yahoo.com/caas/content/article/")+"?uuid="+r+"&"+u.contextParams;return h.classList.add("wafer-caas-trigger-inprogress"),this._state.status=0,new Promise(function(t,n){if(!e._util.loadAssets&&!window.CAAS)return void n(new Error("CAAS Base is missing"));if("default"===_){var i=window.__waferCaasCollection.get(r);if(i)return C=!0,void t(i)}y(a,{cache:l,cacheKey:b,cacheStrategy:f,cacheTtl:v,timeout:g}).then(function(e){t(e)}).catch(function(e){n(e)})}).then(function(t){var a=t.assets;if(!e._util.loadAssets||!a.length)return t;var r=t.style;return e.loadCaasAssets(a,r).then(function(){return t})}).then(function(t){var n=_.length?_[0].toUpperCase()+_.slice(1):"",i=e["handle"+n],o=t._fetchMeta||{},c=o.duration,u=o.source;d.destroy(h,{destroySelf:!1});var l=void 0;if("default"===_){var f=t||{},v=f.assets,m=f.items,y=void 0===m?[]:m,g={};y.length>1?y.some(function(e){return((e||{}).data||{}).partnerData.uuid===r&&(g=e,!0)}):g=y[0],l=(g||{}).markup,h.innerHTML=l,!C&&window.__waferCaasCollection.set(r,{assets:v,items:[g]})}else if("sidekick"===_)if(l=t.markup,w){var b=document.createElement("div"),k=document.createElement("div");b.innerHTML=l,k.innerHTML=l;for(var E=p(b.getElementsByClassName("sidekick-item")),A=E.length,P=Math.round(A/2),j=P+1;j<A;j++){var O=E[j].parentNode;O.parentNode.removeChild(O)}h.innerHTML=b.innerHTML;for(var S=p(k.getElementsByClassName("sidekick-item")),T=0;T<=P;T++){var I=S[T].parentNode;I.parentNode.removeChild(I)}h.innerHTML=b.innerHTML,w.innerHTML=k.innerHTML}else h.innerHTML=l;if(e._util["caas-collapsed"]){var L=p(h.getElementsByClassName("caas-body-wrapper"))[0];L&&L.classList.add("caas-body-collapsed")}return e.updateCategoryLabel(),i&&setTimeout(function(){i.call(e,h,t)},0),h.classList.remove("wafer-caas-trigger-inprogress"),h.classList.add(s),d.emitLog({name:"WaferCaas",elem:h,meta:{duration:c,source:C?"MEMORY":u,url:a}}),!0}).catch(function(t){return d.emitWaferEvent("caas:"+("default"===_?"article":_)+":error",{elem:h,meta:{url:a,uuid:r},stack:t.stack}),h.classList.remove("wafer-caas-trigger-inprogress"),h.classList.add(m),h.classList.remove(s),d.destroy(h),e._state.status=2,!1})}return Promise.resolve(!1)}},{key:"handleSidekick",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=this._util,r=a["caas-url"],n=a.elem,i=a.secondNode;if(!t.markup)return void d.emitWaferEvent("caas:sidekick:error",{elem:n,meta:{url:r}});d.emitWaferEvent("caas:sidekick:init",{elem:n,meta:{url:r}}),this._state.status=1,d.sync(e),i&&d.sync(i)}},{key:"handleDefault",value:function(e){var t=this,a=this._util,n=a.elem,i=a["caas-uuid"],s=window.__waferCaasCollection.get(i)||{},c=s.items,l=void 0===c?[]:c,f=u(l,1),v=f[0];v=void 0===v?{}:v;var h=v.data;if(!v.markup||!h)return void d.emitWaferEvent("caas:article:error",{elem:n,meta:{uuid:i}});var m=h.partnerData;if(window._caasInstance)window._caasInstance.sync(),d.emitWaferEvent("caas:article:sync",{elem:n,meta:{data:m,instance:window._caasInstance}});else{var w=this._util.wrapper,p=window.wafer.wafers["wafer-video"];p&&(!0===p.__esModule?p.default.pause("wafer-caas"):p.pause("wafer-caas")),window._caasInstance=new window.CAAS.BASE({container:w}),window._caasInstance.on("link:clicked",function(e){if(e.isYahoo){var a=t._util.caasConfig,s=void 0===a?{}:a,c=s.contextParams,l=void 0===c?{}:c,f=(s.caasUrl||"https://www.yahoo.com/caas/content/article/")+"?url="+e.href+"&"+l;return d.emitWaferEvent("caas:yahooLink:clicked",{elem:n,meta:{data:e,instance:window._caasInstance}}),y(f,{timeout:2e3}).then(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.items,a=void 0===t?[]:t,n=e.assets;return(0,(o||r()).handlePrefetchedData)(a,n,l)}).then(function(t){var a=u(t,1),r=a[0];r=void 0===r?{}:r;var s=r.data,o=s.partnerData,c=void 0===o?{}:o,l=c.uuid;d.emitWaferEvent("caas:yahooLink:fetched",{elem:n,meta:{data:Object.assign({parentUuid:i,uuid:l},e),instance:window._caasInstance}})}).catch(function(){d.emitWaferEvent("caas:link:clicked",{elem:n,meta:{data:e,instance:window._caasInstance}})})}d.emitWaferEvent("caas:link:clicked",{elem:n,meta:{data:e,instance:window._caasInstance}})}),d.emitWaferEvent("caas:article:init",{elem:n,meta:{data:m,instance:window._caasInstance}})}this._state.status=1,d.sync(e)}},{key:"handleArticleInViewport",value:function(){var e=this._util,t=e.elem,a=e["caas-uuid"],r=window.__waferCaasCollection.get(a)||{},n=r.items,i=void 0===n?[]:n,s=u(i,1),o=s[0];o=void 0===o?{}:o;var c=o.data;if(o.markup&&c){var l=c.partnerData;d.emitWaferEvent("caas:article:inview",{elem:t,meta:{data:l,instance:window._caasInstance}})}}},{key:"stateDidUpdate",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.stateAttr;if("caas-collapsed"!==t){if("caas-category-label"===t)return void this.updateCategoryLabel();"stateChange"===this._util.trigger&&this.fetch().catch(function(){})}else{if(!this._util.elem)return;if(this._util["caas-collapsed"]=Number(this._util["caas-collapsed"]),this._util["caas-collapsed"]){var a=p(this._util.elem.getElementsByClassName("caas-body-wrapper"))[0];a&&a.classList.add("caas-body-collapsed")}}}},{key:"config",get:function(){var e=this._util,t=e["caas-url"],a=e["caas-uuid"];return{caasConfig:e.caasConfig,href:e.href,isPrefetch:e.isPrefetch,offsetX:e.offsetX,offsetY:e.offsetY,selector:e.selector,trigger:e.trigger,type:e.type,url:t,uuid:a}}}]),t}(m);t.default=k,e.exports=t.default},"./src/controller.js":function(e,t,a){"use strict";function r(){return u=i(a("./src/base.js"))}function n(){return l=a("./src/utils.js")}function i(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u,l,f=function(){function e(e,t){var a=[],r=!0,n=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(a.push(s.value),!t||a.length!==t);r=!0);}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}return a}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),d=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),v=window.wafer,h=v.base,m=v.utils,w=m.elementInView,p=m.fetchWithCache,y=m.getConfigFromJSONScriptNode,g=m.throttle,_=window.wafer.controllers.WaferBaseController;window.__waferCaasCollection=function(){var e=new Map,t=[],a=new Map;return{addAndBeaconDuplicateId:function(t){if(e.has(t))return void setTimeout(function(){h.emitWaferEvent("caas:prefetch:duplicate:id",{meta:{uuid:t}})},0);e.set(t,!0)},set:function(e,r){t.push(e),a.set(e,r)},freeMemory:function(e){if(!(t.length<25)){var r=t[0];window.wafer.db.get(r+":"+e,"fetch",{timeout:1e3}).then(function(e){if(!e)return void h.emitWaferEvent("caas:set:remove:failed");var n=t.indexOf(r);t.splice(n,1),a.delete(r)}).catch(function(){h.emitWaferEvent("caas:set:indexeddb:failed")})}},get:function(e){return a.get(e)}}}();var b=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=e.errorClass,n=void 0===a?"wafer-caas-error":a,i=e.root,c=void 0===i?document:i,l=e.selector,f=e.successClass,d=void 0===f?"wafer-caas-complete":f,v=e.validateDelay,h=void 0===v?25:v;s(this,t);var m=y(document.getElementById("wafer-caas-config")),w=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{root:c,selector:l,props:{caasConfig:m,errorClass:n,selector:l,successClass:d},WaferClass:(u||r()).default}));return w._validateWithThrottle=g(function(){w.validate()},h,w),w._state=w._state||{},w.sync(),w.addPublicAPIs(m),w}return c(t,e),d(t,[{key:"addPublicAPIs",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.contextParams,a=void 0===t?{}:t;window.wafer.caas||(window.wafer.caas={getData:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return Promise.all(e.map(function(e){return new Promise(function(t){var r=window.__waferCaasCollection.get(e);if(r){var n=f(r.items,1),i=n[0].data;return t((void 0===i?{}:i).partnerData||{})}if(!window.wafer.db)return t({});window.wafer.db.get(e+":"+a,"fetch",{timeout:3e3}).then(function(e){try{var a=JSON.parse(e.value),r=a.items,n=f(r,1),i=n[0].data;return t((void 0===i?{}:i).partnerData||{})}catch(e){return t({})}}).catch(function(e){t({})})})}))}})}},{key:"prefetch",value:function(){if(window.CAAS){var e=this._state.elementInstances,t={},a=[],r=[],i=void 0,s=void 0,o=void 0,c=0,u=0,f=!0,d=!1,v=void 0;try{for(var m,w=e.values()[Symbol.iterator]();!(f=(m=w.next()).done);f=!0){var y=m.value;a[c]=a[c]||[];var g=y.instance,_=g.config,b=_.caasConfig,C=void 0===b?{}:b,k=_.href,E=_.isPrefetch,A=_.uuid;if(o=o||C.caasUrl,s=s||C.contextParams||"",E&&A){var P=t[A];!P&&a[c].push({href:k,uuid:A}),t[A]=!0,g.destroy(),!P&&++u>=10&&(u=0,c++)}}}catch(e){d=!0,v=e}finally{try{!f&&w.return&&w.return()}finally{if(d)throw v}}return Promise.all(a.map(function(e){var t=e.map(function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).uuid});if(t.length)return i=(o||"https://www.yahoo.com/caas/content/article/")+"?uuid="+t.join(",")+"&"+s,p(i,{cache:0}).then(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=t.items,i=void 0===a?[]:a,o=t.assets;return(0,(l||n()).handlePrefetchedData)(i,o,s,function(t){var a=e[t].href;a&&r.push(a)})})})).then(function(){if(r.length)return Promise.all(r.map(function(e){return p((o||"https://www.yahoo.com/caas/content/article/")+"?url="+e+"&"+s,{cache:0}).then(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.items,a=void 0===t?[]:t,r=e.assets;return(0,(l||n()).handlePrefetchedData)(a,r,s)})}))}).then(function(){h.emitWaferEvent("caas:prefetch:success",{meta:{url:i}})}).catch(function(){h.emitWaferEvent("caas:prefetch:failed",{meta:{url:i}})})}}},{key:"handleScroll",value:function(){this._validateWithThrottle()}},{key:"handleResize",value:function(){this._validateWithThrottle()}},{key:"didSync",value:function(){var e=this,t=this._state,a=t.elementInstances,r=t.mounted;0===a.size||r||(this._state.mounted=!0),setTimeout(function(){e.prefetch()},10)}},{key:"trigger",value:function(e){var t=this._state.elementInstances.get(e);if(t){t.instance.fetch()}}},{key:"willValidate",value:function(e){var t=this,a=this._state.elementInstances;e.forEach(function(e){var r=a.get(e),n=r.instance;if(!n.config.isPrefetch){var i=n.config,s=i.offsetX,o=i.offsetY,c=i.selector,u=i.trigger,l=i.type,f=w(e,{offsetX:s,offsetY:o},h.viewport);switch(u){case"viewport":1!==n._state.status&&f&&n.fetch().then(function(t){t&&c&&e.classList.remove(c.replace(".",""))}).catch(function(){});break;case"onLoad":n.fetch().then(function(t){t&&c&&e.classList.remove(c.replace(".",""))}).catch(function(){})}f&&t._state.activeElem===e||t._state.activeElem&&w(t._state.activeElem,{offsetX:s,offsetY:o},h.viewport)||1===n._state.status&&f&&"default"===l&&t._state.activeElem!==e&&(n.handleArticleInViewport(),t._state.activeElem=e)}})}},{key:"didDestroy",value:function(e){this._state.activeElem===e&&(this._state.activeElem=null);var t=!0,a=this._state.elementInstances,r=!0,n=!1,i=void 0;try{for(var s,o=a.values()[Symbol.iterator]();!(r=(s=o.next()).done);r=!0){var c=s.value,u=c.instance.config,l=u.isPrefetch;if("default"===u.type&&!l){t=!1;break}}}catch(e){n=!0,i=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw i}}if(t){var f=window.wafer.wafers["wafer-video"];window._caasInstance&&(window._caasInstance.destructor(),window._caasInstance=null),f&&(!0===f.__esModule?f.default.resume("wafer-caas"):f.resume("wafer-caas"))}}}]),t}(_);t.default=b,e.exports=t.default},"./src/entry.js":function(e,t,a){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n;t.default=new((n||function(){return n=r(a("./src/controller.js"))}()).default)({selector:"wafer-caas"}),e.exports=t.default},"./src/utils.js":function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.handlePrefetchedData=function(e,t,a,r){return Promise.all(e.map(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments[1],i=e.data,s=void 0===i?{}:i,o=s.partnerData;if(!o)return r&&r(n),Promise.resolve();var c=o.uuid,u={assets:t,items:[e]};return window.__waferCaasCollection.set(c,u),window.wafer.db.set({cachedTime:Date.now(),key:c+":"+a,ttl:1200,value:JSON.stringify(u)},"fetch").then(function(t){return t&&window.__waferCaasCollection.freeMemory(a),e}).catch(function(){return e})}))}}})});